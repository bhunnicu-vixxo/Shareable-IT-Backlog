name: Deploy to Validation-K8S

on:
  push:
    branches: [main]

concurrency:
  group: deploy-validation
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/shareable-it-backlog

jobs:
  # ---------------------------------------------------------------------------
  # Build and push Docker images to GitHub Container Registry
  # ---------------------------------------------------------------------------
  build-images:
    name: Build & Push Images
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "tag=sha-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/backend:${{ steps.meta.outputs.tag }}
            ${{ env.IMAGE_PREFIX }}/backend:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/frontend:${{ steps.meta.outputs.tag }}
            ${{ env.IMAGE_PREFIX }}/frontend:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  # ---------------------------------------------------------------------------
  # Deploy to Validation-K8S cluster
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-images
    environment: validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.VALIDATION_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster connectivity
        run: kubectl get nodes --request-timeout=10s

      - name: Apply namespace
        run: kubectl apply -f k8s/namespace.yaml

      - name: Apply configmap
        run: kubectl apply -f k8s/configmap.yaml

      - name: Apply secrets (if not exists)
        run: |
          if ! kubectl -n bridge get secret slb-secrets &>/dev/null; then
            echo "WARNING: slb-secrets does not exist in namespace bridge."
            echo "Create it manually before the first deployment:"
            echo "  kubectl -n bridge create secret generic slb-secrets \\"
            echo "    --from-literal=DATABASE_URL='postgresql://tadmin:PASS@transact-nonprod.postgres.database.azure.com:5432/linear?sslmode=require' \\"
            echo "    --from-literal=DB_USER='...' \\"
            echo "    --from-literal=DB_PASSWORD='...' \\"
            echo "    --from-literal=LINEAR_API_KEY='...' \\"
            echo "    --from-literal=SESSION_SECRET='...' \\"
            echo "    --from-literal=ALLOWED_ORIGINS='...'"
            exit 1
          fi
          echo "Secret slb-secrets exists."

      - name: Run database migrations
        env:
          IMAGE_TAG: ${{ needs.build-images.outputs.image-tag }}
        run: |
          # Delete previous migration job if it exists
          kubectl -n bridge delete job slb-migrate --ignore-not-found=true

          # Apply migration job with the current image tag
          sed "s|:latest|:${IMAGE_TAG}|g" k8s/migration-job.yaml | kubectl apply -f -

          echo "Waiting for migration job to complete..."
          kubectl -n bridge wait --for=condition=complete job/slb-migrate --timeout=120s

          echo "Migration logs:"
          kubectl -n bridge logs job/slb-migrate

      - name: Deploy nginx configmap
        run: kubectl apply -f k8s/nginx-configmap.yaml

      - name: Deploy backend
        env:
          IMAGE_TAG: ${{ needs.build-images.outputs.image-tag }}
        run: |
          sed "s|:latest|:${IMAGE_TAG}|g" k8s/backend.yaml | kubectl apply -f -
          kubectl -n bridge rollout status deployment/slb-backend --timeout=180s

      - name: Deploy frontend
        env:
          IMAGE_TAG: ${{ needs.build-images.outputs.image-tag }}
        run: |
          sed "s|:latest|:${IMAGE_TAG}|g" k8s/frontend.yaml | kubectl apply -f -
          kubectl -n bridge rollout status deployment/slb-frontend --timeout=120s

      - name: Apply ingress
        run: kubectl apply -f k8s/ingress.yaml

      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl -n bridge get deployments
          echo ""
          echo "=== Pods ==="
          kubectl -n bridge get pods
          echo ""
          echo "=== Services ==="
          kubectl -n bridge get services
          echo ""
          echo "=== Ingress ==="
          kubectl -n bridge get ingress

      - name: Deployment summary
        run: |
          echo "============================================="
          echo "  Deployment to Validation-K8S complete"
          echo "  Namespace: bridge"
          echo "  Image tag: ${{ needs.build-images.outputs.image-tag }}"
          echo "  Commit:    ${{ github.sha }}"
          echo "============================================="
