# Story 17.1: AI-Powered Weekly Digest — "This Week in IT"

Linear Issue ID: VIX-438
Status: ready-for-dev

## Story

As a business stakeholder,
I want to receive a weekly summary of what IT accomplished, what's in progress, and what's coming up — written in plain business language,
so that I stay informed without having to check the app or ask IT for status updates.

## Acceptance Criteria

1. **Given** it is the configured digest day/time, **When** the digest job runs, **Then** it pulls the past week's data from Linear via the sync database for all teams.
2. **Given** raw data has been collected, **When** the AI summarization runs, **Then** it produces a business-friendly narrative grouped by team.
3. **Given** the digest is generated, **When** I navigate to the digest page (`/digest`), **Then** I see the most recent weekly summary and can browse past weeks.
4. **Given** an admin triggers a manual generation, **When** the job completes, **Then** the new digest is visible immediately.
5. The digest includes: items completed, items started, new items added, and notable blockers — grouped by team.
6. The digest uses plain business language (no engineering jargon, no Linear identifiers in headlines).
7. The digest handles weeks with no activity gracefully ("Quiet week — no major changes").
8. **Build passes**: `npm run build` passes with zero TypeScript errors in both `backend/` and `frontend/`. All existing tests continue to pass.

## Tasks / Subtasks

- [ ] Task 1: Backend — Create weekly digest data collection service (AC: #1, #5)
  - [ ] Create `backend/src/services/digest/digest-data.service.ts`
  - [ ] Query backlog_items for changes in the past 7 days:
    - Items where `status` changed to "completed" (completed this week)
    - Items where `status` changed to "started" (started this week)
    - Items created in the past 7 days (new items)
    - Items with status "blocked" or similar indicators
  - [ ] Group results by team/project label
  - [ ] Return structured data object: `{ weekStart, weekEnd, teams: [{ name, completed, started, new, blocked }] }`
- [ ] Task 2: Backend — Create AI summarization service (AC: #2, #6, #7)
  - [ ] Create `backend/src/services/digest/digest-ai.service.ts`
  - [ ] Integrate with OpenAI API (or configurable LLM provider)
  - [ ] Add `OPENAI_API_KEY` to environment configuration
  - [ ] Design prompt template that:
    - Receives structured weekly data
    - Outputs business-friendly Markdown narrative
    - Groups by team with highlights
    - Includes "Highlights" summary section
    - Includes "Coming Up" section
    - Handles empty weeks gracefully
  - [ ] Add error handling: if AI is unavailable, generate a basic data-only summary
- [ ] Task 3: Backend — Create digest storage and API (AC: #3, #4)
  - [ ] Create database migration: `weekly_digests` table (`id`, `week_start`, `week_end`, `content_md`, `raw_data_json`, `generated_at`, `generated_by`)
  - [ ] Create `backend/src/services/digest/digest.service.ts` — orchestrates collection + AI + storage
  - [ ] `GET /api/digests` — list digests (paginated, newest first)
  - [ ] `GET /api/digests/:id` — get single digest
  - [ ] `GET /api/digests/latest` — get most recent digest
  - [ ] `POST /api/admin/digests/generate` — manual trigger (admin only)
  - [ ] Add routes in `backend/src/routes/digest.routes.ts`
- [ ] Task 4: Backend — Schedule automatic generation (AC: #1)
  - [ ] Extend the existing `node-cron` scheduler (used for sync) to add a weekly digest job
  - [ ] Default schedule: Monday 8:00 AM (configurable via env `DIGEST_SCHEDULE`)
  - [ ] Job calls `digest.service.generate()` and logs result
- [ ] Task 5: Frontend — Create digest page (AC: #3)
  - [ ] Create `frontend/src/features/digest/` feature directory
  - [ ] Create `frontend/src/features/digest/components/digest-page.tsx`
  - [ ] Add `/digest` route to `App.tsx`
  - [ ] Add "This Week in IT" navigation link to `AppHeader`
  - [ ] Display latest digest as rendered Markdown (reuse `MarkdownContent` component from backlog feature)
  - [ ] Add digest archive sidebar/dropdown to browse past weeks
  - [ ] Show generation date and "Generated by AI" attribution
- [ ] Task 6: Frontend — Admin manual trigger (AC: #4)
  - [ ] Add "Generate Digest" button on the admin page (admin-only visibility)
  - [ ] Call `POST /api/admin/digests/generate` and show loading/success/error states
  - [ ] On success, navigate to the digest page showing the new digest
- [ ] Task 7: Write tests (AC: #8)
  - [ ] Backend: Test digest data service collects correct items by date range
  - [ ] Backend: Test digest AI service generates markdown (mock the LLM call)
  - [ ] Backend: Test API endpoints (CRUD for digests, admin generate)
  - [ ] Frontend: Test digest page renders markdown content
  - [ ] Frontend: Test archive navigation between weeks
  - [ ] Frontend: Test admin generate button calls API

## Dev Notes

### Architecture Compliance

- **Backend services**: Follow existing layer pattern — route → controller → service. New feature directory `backend/src/services/digest/`.
- **Frontend feature**: New `frontend/src/features/digest/` directory following established pattern.
- **Scheduling**: Extend existing `node-cron` patterns from `backend/src/services/sync/sync-scheduler.service.ts`.
- **Database**: New `weekly_digests` table. Follow existing migration conventions.
- **Auth**: Digest page is accessible to all authenticated users. Generate endpoint is admin-only.

### Critical Implementation Details

- **Phase 1 scope**: In-app digest page with manual admin trigger. Automated scheduling. No email/Slack delivery yet.
- **LLM integration**: Use OpenAI `gpt-4o-mini` for cost efficiency (digest is ~500 tokens input, ~1000 tokens output). Store API key as `OPENAI_API_KEY` env var. Use `openai` npm package.
- **Prompt engineering**: The prompt should include:
  ```
  You are a business communications writer for an IT department.
  Write a weekly summary for non-technical business stakeholders.
  Use plain language. No engineering jargon. No issue identifiers in headlines.
  Group by team. Lead with highlights. End with what's coming next.
  ```
- **Data collection**: Query the `backlog_items` table directly (already synced from Linear). Look at `status` field changes. If we don't track status history, compare current status with a snapshot approach — or use `updated_at` timestamps.
- **Markdown rendering**: Reuse `MarkdownContent` component from `frontend/src/features/backlog/components/markdown-content.tsx` — it already handles Markdown → React rendering.
- **Fallback on AI failure**: If the LLM call fails (API error, key missing), generate a simple data-only digest: "Completed: [list]. Started: [list]. New: [list]."
- **node-cron**: Already used in `sync-scheduler.service.ts`. Pattern: `cron.schedule('0 8 * * 1', callback)` for Monday 8 AM.

### Existing Code to Reuse

- `sync-scheduler.service.ts` at `backend/src/services/sync/sync-scheduler.service.ts` — cron scheduling pattern
- `MarkdownContent` at `frontend/src/features/backlog/components/markdown-content.tsx` — Markdown rendering
- Database utility at `backend/src/utils/database.ts` — query execution
- Admin middleware at `backend/src/middleware/admin.middleware.ts` — protect generate endpoint
- Auth middleware at `backend/src/middleware/auth.middleware.ts` — protect all digest endpoints
- Pino logger at `backend/src/utils/logger.ts` — structured logging

### Anti-Patterns to Avoid

- Do NOT call the Linear API directly for digest data — use the already-synced data in PostgreSQL
- Do NOT send the raw AI prompt to the client — only send the generated digest content
- Do NOT hardcode the LLM provider — use a service abstraction so it can be swapped later
- Do NOT block the digest page on generation — show previously generated digests while new one generates
- Do NOT skip error handling on the AI call — always have a fallback data-only summary
- Do NOT store the OpenAI API key in code — use environment variable only

### Project Structure Notes

**New files:**
- `backend/src/services/digest/digest-data.service.ts`
- `backend/src/services/digest/digest-ai.service.ts`
- `backend/src/services/digest/digest.service.ts`
- `backend/src/routes/digest.routes.ts`
- `backend/src/controllers/digest.controller.ts`
- `frontend/src/features/digest/components/digest-page.tsx`
- `frontend/src/features/digest/hooks/use-digests.ts`
- Database migration for `weekly_digests` table

**Modified files:**
- `frontend/src/App.tsx` (add /digest route)
- `frontend/src/shared/components/layout/app-header.tsx` (add digest nav link)
- `backend/src/routes/index.ts` (register digest routes)
- `backend/src/services/sync/sync-scheduler.service.ts` (add digest cron job, or create separate scheduler)
- `backend/src/config/env.ts` (add OPENAI_API_KEY, DIGEST_SCHEDULE env vars)

### Dependencies

- `openai` npm package (new dependency for backend)
- `OPENAI_API_KEY` environment variable (must be configured)

### References

- [Source: backend/src/services/sync/sync-scheduler.service.ts] — Cron scheduling pattern
- [Source: backend/src/services/sync/linear-transformers.ts] — Data transformation patterns
- [Source: frontend/src/features/backlog/components/markdown-content.tsx] — Markdown rendering component
- [Source: backend/src/middleware/admin.middleware.ts] — Admin authorization
- [Source: backend/src/utils/database.ts] — Database query patterns
- [Source: backend/src/config/env.ts] — Environment configuration
- [Source: _bmad-output/planning-artifacts/architecture.md] — Layer architecture, PostgreSQL, Express patterns

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
